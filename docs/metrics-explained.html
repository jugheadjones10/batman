<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detection Metrics Explained</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            padding: 40px 20px;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h2 .number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .visualization {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .viz-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #555;
        }
        
        canvas {
            display: block;
            margin: 0 auto;
        }
        
        .formula {
            background: #e8f4f8;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            border-radius: 0 8px 8px 0;
        }
        
        .example-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .example-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .slider-container {
            margin: 20px 0;
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 10px 0;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .stat-box .label {
            opacity: 0.9;
            margin-top: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .correct { color: #28a745; font-weight: bold; }
        .incorrect { color: #dc3545; font-weight: bold; }
        
        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .calibration-bar {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .calibration-bar .label {
            width: 80px;
            font-weight: 500;
        }
        
        .calibration-bar .bar-container {
            flex: 1;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .calibration-bar .bar {
            height: 100%;
            border-radius: 15px;
            transition: width 0.3s ease;
        }
        
        .calibration-bar .expected {
            position: absolute;
            top: 0;
            height: 100%;
            width: 3px;
            background: #333;
        }
        
        .calibration-bar .value {
            width: 60px;
            text-align: right;
            font-weight: bold;
        }

        .interactive-note {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #004085;
        }

        .summary-card {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .summary-card h3 {
            margin-bottom: 15px;
        }

        .summary-card ul {
            list-style: none;
            padding: 0;
        }

        .summary-card li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .summary-card li:last-child {
            border-bottom: none;
        }

        .pr-curve-container {
            position: relative;
        }

        .ap-value-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Object Detection Metrics</h1>
            <p>Interactive guide for understanding RF-DETR evaluation metrics</p>
        </header>

        <!-- IoU Section -->
        <div class="card">
            <h2><span class="number">1</span> IoU (Intersection over Union)</h2>
            <p>IoU measures how well your predicted bounding box overlaps with the ground truth. It's the foundation for all other metrics.</p>
            
            <div class="formula">
                IoU = Area of Overlap / Area of Union
            </div>
            
            <div class="visualization">
                <div class="viz-title">Interactive IoU Visualization</div>
                <canvas id="iouCanvas" width="500" height="300"></canvas>
                <div class="slider-container">
                    <label>Move the predicted box (drag slider):</label>
                    <input type="range" id="iouSlider" min="0" max="100" value="70">
                </div>
                <div class="metric-value">IoU: <span id="iouValue">0.00</span></div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(40, 167, 69, 0.3); border: 3px solid #28a745;"></div>
                        <span>Ground Truth</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(0, 123, 255, 0.3); border: 3px solid #007bff;"></div>
                        <span>Prediction</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(255, 193, 7, 0.7);"></div>
                        <span>Overlap</span>
                    </div>
                </div>
            </div>
            
            <div class="interactive-note">
                üí° <strong>Try it:</strong> Drag the slider to see how IoU changes as the predicted box moves. Notice how IoU = 1.0 means perfect overlap, and IoU = 0.0 means no overlap.
            </div>
        </div>

        <!-- Precision & Recall Section -->
        <div class="card">
            <h2><span class="number">2</span> Precision & Recall</h2>
            
            <div class="grid-2">
                <div>
                    <h3 style="color: #28a745; margin-bottom: 10px;">Precision</h3>
                    <p>"Of all boxes I predicted, how many were correct?"</p>
                    <div class="formula">
                        Precision = TP / (TP + FP)
                    </div>
                    <p><strong>High precision</strong> = Few false alarms</p>
                </div>
                <div>
                    <h3 style="color: #007bff; margin-bottom: 10px;">Recall</h3>
                    <p>"Of all actual objects, how many did I find?"</p>
                    <div class="formula">
                        Recall = TP / (TP + FN)
                    </div>
                    <p><strong>High recall</strong> = Few missed objects</p>
                </div>
            </div>
            
            <div class="visualization">
                <div class="viz-title">Detection Scenario Simulator</div>
                <canvas id="prCanvas" width="500" height="350"></canvas>
                <div class="slider-container">
                    <label>Confidence Threshold: <span id="thresholdValue">0.50</span></label>
                    <input type="range" id="thresholdSlider" min="10" max="90" value="50">
                </div>
                <div class="grid-2" style="margin-top: 20px;">
                    <div class="stat-box">
                        <div class="value" id="precisionValue">0.00</div>
                        <div class="label">Precision</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="recallValue">0.00</div>
                        <div class="label">Recall</div>
                    </div>
                </div>
                <div class="legend" style="margin-top: 20px;">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #28a745;"></div>
                        <span>True Positive (TP)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dc3545;"></div>
                        <span>False Positive (FP)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffc107;"></div>
                        <span>False Negative (FN)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #6c757d; opacity: 0.5;"></div>
                        <span>Below Threshold</span>
                    </div>
                </div>
            </div>
            
            <div class="interactive-note">
                üí° <strong>Try it:</strong> Adjust the confidence threshold. Notice the trade-off: higher threshold = better precision but lower recall (and vice versa).
            </div>
        </div>

        <!-- AP Section -->
        <div class="card">
            <h2><span class="number">3</span> AP@50 vs AP@75</h2>
            <p>Average Precision (AP) summarizes precision across all recall levels. The number after @ is the IoU threshold.</p>
            
            <div class="grid-2">
                <div class="example-box">
                    <h4>AP@50 (Lenient)</h4>
                    <p>A prediction counts as correct if IoU ‚â• 0.50</p>
                    <p>‚úÖ Box can be somewhat off and still count</p>
                </div>
                <div class="example-box" style="background: #f8d7da; border-color: #f5c6cb;">
                    <h4 style="color: #721c24;">AP@75 (Strict)</h4>
                    <p>A prediction counts as correct if IoU ‚â• 0.75</p>
                    <p>‚ö†Ô∏è Box must be well-aligned to count</p>
                </div>
            </div>
            
            <div class="visualization">
                <div class="viz-title">Same Predictions, Different IoU Thresholds</div>
                <canvas id="apCanvas" width="500" height="200"></canvas>
                
                <table style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Prediction</th>
                            <th>IoU Score</th>
                            <th>Correct @ AP50?</th>
                            <th>Correct @ AP75?</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Cat #1</td>
                            <td>0.82</td>
                            <td class="correct">‚úì Yes</td>
                            <td class="correct">‚úì Yes</td>
                        </tr>
                        <tr>
                            <td>Cat #2</td>
                            <td>0.63</td>
                            <td class="correct">‚úì Yes</td>
                            <td class="incorrect">‚úó No</td>
                        </tr>
                        <tr>
                            <td>Cat #3</td>
                            <td>0.51</td>
                            <td class="correct">‚úì Yes</td>
                            <td class="incorrect">‚úó No</td>
                        </tr>
                        <tr>
                            <td>Cat #4</td>
                            <td>0.45</td>
                            <td class="incorrect">‚úó No</td>
                            <td class="incorrect">‚úó No</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="grid-2" style="margin-top: 20px;">
                    <div class="stat-box" style="background: linear-gradient(135deg, #28a745, #20c997);">
                        <div class="value">75%</div>
                        <div class="label">Accuracy @ AP50</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #dc3545, #fd7e14);">
                        <div class="value">25%</div>
                        <div class="label">Accuracy @ AP75</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Precision-Recall Curve & mAP -->
        <div class="card">
            <h2><span class="number">4</span> Precision-Recall Curve & mAP</h2>
            <p>AP is the area under the Precision-Recall curve. mAP averages AP across all classes.</p>
            
            <div class="visualization">
                <div class="viz-title">Precision-Recall Curve</div>
                <div class="pr-curve-container">
                    <canvas id="prCurveCanvas" width="500" height="350"></canvas>
                    <div class="ap-value-display">
                        AP = <span id="apAreaValue">0.72</span>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 15px; color: #666;">
                    The <strong>shaded area</strong> under the curve equals the Average Precision (AP)
                </p>
            </div>
            
            <div class="formula" style="margin-top: 20px;">
                mAP = (AP_class1 + AP_class2 + ... + AP_classN) / N
            </div>
            
            <div class="example-box">
                <h4>Example: 3-Class Detection</h4>
                <table>
                    <tr><td>Cat AP</td><td>0.85</td></tr>
                    <tr><td>Dog AP</td><td>0.72</td></tr>
                    <tr><td>Bird AP</td><td>0.68</td></tr>
                    <tr style="font-weight: bold; background: #fff3cd;">
                        <td>mAP</td>
                        <td>(0.85 + 0.72 + 0.68) / 3 = <strong>0.75</strong></td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Calibration Error -->
        <div class="card">
            <h2><span class="number">5</span> Calibration Error</h2>
            <p>A well-calibrated model's confidence scores match real-world accuracy. When it says "80% confident", it should be correct ~80% of the time.</p>
            
            <div class="visualization">
                <div class="viz-title">Calibration Comparison</div>
                
                <h4 style="margin: 20px 0 10px; color: #28a745;">‚úì Well-Calibrated Model</h4>
                <div class="calibration-bar">
                    <div class="label">90% conf</div>
                    <div class="bar-container">
                        <div class="bar" style="width: 88%; background: #28a745;"></div>
                        <div class="expected" style="left: 90%;"></div>
                    </div>
                    <div class="value" style="color: #28a745;">88%</div>
                </div>
                <div class="calibration-bar">
                    <div class="label">70% conf</div>
                    <div class="bar-container">
                        <div class="bar" style="width: 72%; background: #28a745;"></div>
                        <div class="expected" style="left: 70%;"></div>
                    </div>
                    <div class="value" style="color: #28a745;">72%</div>
                </div>
                <div class="calibration-bar">
                    <div class="label">50% conf</div>
                    <div class="bar-container">
                        <div class="bar" style="width: 48%; background: #28a745;"></div>
                        <div class="expected" style="left: 50%;"></div>
                    </div>
                    <div class="value" style="color: #28a745;">48%</div>
                </div>
                
                <h4 style="margin: 30px 0 10px; color: #dc3545;">‚úó Poorly-Calibrated Model (Overconfident)</h4>
                <div class="calibration-bar">
                    <div class="label">90% conf</div>
                    <div class="bar-container">
                        <div class="bar" style="width: 62%; background: #dc3545;"></div>
                        <div class="expected" style="left: 90%;"></div>
                    </div>
                    <div class="value" style="color: #dc3545;">62%</div>
                </div>
                <div class="calibration-bar">
                    <div class="label">70% conf</div>
                    <div class="bar-container">
                        <div class="bar" style="width: 45%; background: #dc3545;"></div>
                        <div class="expected" style="left: 70%;"></div>
                    </div>
                    <div class="value" style="color: #dc3545;">45%</div>
                </div>
                <div class="calibration-bar">
                    <div class="label">50% conf</div>
                    <div class="bar-container">
                        <div class="bar" style="width: 28%; background: #dc3545;"></div>
                        <div class="expected" style="left: 50%;"></div>
                    </div>
                    <div class="value" style="color: #dc3545;">28%</div>
                </div>
                
                <p style="margin-top: 20px; color: #666; font-size: 0.9rem;">
                    <strong>Black line</strong> = Expected accuracy based on confidence | <strong>Colored bar</strong> = Actual accuracy
                </p>
            </div>
            
            <div class="formula">
                ECE = Œ£ (|accuracy_bin - confidence_bin| √ó samples_in_bin) / total_samples
            </div>
            
            <div class="interactive-note">
                üí° <strong>Why it matters:</strong> If you're setting a confidence threshold for production (e.g., "only show predictions with >70% confidence"), calibration error tells you if that threshold is meaningful.
            </div>
        </div>

        <!-- Summary -->
        <div class="card">
            <h2><span class="number">üìä</span> Summary: Which Metric for What?</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Question It Answers</th>
                        <th>Use When...</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>AP@50</strong></td>
                        <td>Can the model detect the object at all?</td>
                        <td>Rough localization is acceptable</td>
                    </tr>
                    <tr>
                        <td><strong>AP@75</strong></td>
                        <td>Can the model localize precisely?</td>
                        <td>Tight bounding boxes matter</td>
                    </tr>
                    <tr>
                        <td><strong>mAP</strong></td>
                        <td>How good is overall performance?</td>
                        <td>Comparing models or tracking progress</td>
                    </tr>
                    <tr>
                        <td><strong>Precision</strong></td>
                        <td>How trustworthy are positive predictions?</td>
                        <td>False alarms are costly</td>
                    </tr>
                    <tr>
                        <td><strong>Recall</strong></td>
                        <td>Are we missing objects?</td>
                        <td>Missing detections is costly</td>
                    </tr>
                    <tr>
                        <td><strong>Calibration</strong></td>
                        <td>Can we trust confidence scores?</td>
                        <td>Using thresholds in production</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="summary-card">
                <h3>üéØ For Your RF-DETR Experiment</h3>
                <ul>
                    <li><strong>Primary metric:</strong> mAP (COCO-style AP@[.50:.95]) for overall performance</li>
                    <li><strong>Secondary metrics:</strong> AP@50 and AP@75 to understand localization quality</li>
                    <li><strong>Reliability check:</strong> Calibration error to ensure confidence scores are meaningful</li>
                    <li><strong>Per-class analysis:</strong> Precision/Recall to identify specific failure modes</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // IoU Visualization
        const iouCanvas = document.getElementById('iouCanvas');
        const iouCtx = iouCanvas.getContext('2d');
        const iouSlider = document.getElementById('iouSlider');
        const iouValueSpan = document.getElementById('iouValue');

        function drawIoU() {
            const sliderVal = parseInt(iouSlider.value);
            iouCtx.clearRect(0, 0, iouCanvas.width, iouCanvas.height);
            
            // Ground truth box (fixed)
            const gtX = 150, gtY = 75, gtW = 150, gtH = 150;
            
            // Predicted box (moves based on slider)
            const offset = (sliderVal - 70) * 2;
            const predX = 150 + offset, predY = 75, predW = 150, predH = 150;
            
            // Calculate IoU
            const overlapX = Math.max(0, Math.min(gtX + gtW, predX + predW) - Math.max(gtX, predX));
            const overlapY = Math.max(0, Math.min(gtY + gtH, predY + predH) - Math.max(gtY, predY));
            const overlapArea = overlapX * overlapY;
            const unionArea = gtW * gtH + predW * predH - overlapArea;
            const iou = unionArea > 0 ? overlapArea / unionArea : 0;
            
            // Draw overlap first (yellow)
            if (overlapArea > 0) {
                iouCtx.fillStyle = 'rgba(255, 193, 7, 0.7)';
                iouCtx.fillRect(
                    Math.max(gtX, predX),
                    Math.max(gtY, predY),
                    overlapX,
                    overlapY
                );
            }
            
            // Draw ground truth
            iouCtx.strokeStyle = '#28a745';
            iouCtx.lineWidth = 3;
            iouCtx.fillStyle = 'rgba(40, 167, 69, 0.2)';
            iouCtx.fillRect(gtX, gtY, gtW, gtH);
            iouCtx.strokeRect(gtX, gtY, gtW, gtH);
            
            // Draw prediction
            iouCtx.strokeStyle = '#007bff';
            iouCtx.fillStyle = 'rgba(0, 123, 255, 0.2)';
            iouCtx.fillRect(predX, predY, predW, predH);
            iouCtx.strokeRect(predX, predY, predW, predH);
            
            // Labels
            iouCtx.font = '14px sans-serif';
            iouCtx.fillStyle = '#28a745';
            iouCtx.fillText('Ground Truth', gtX, gtY - 10);
            iouCtx.fillStyle = '#007bff';
            iouCtx.fillText('Prediction', predX + predW - 70, predY - 10);
            
            // Draw cat emoji in center
            iouCtx.font = '40px sans-serif';
            iouCtx.fillText('üê±', gtX + gtW/2 - 20, gtY + gtH/2 + 15);
            
            iouValueSpan.textContent = iou.toFixed(2);
            iouValueSpan.style.color = iou >= 0.5 ? '#28a745' : '#dc3545';
        }

        iouSlider.addEventListener('input', drawIoU);
        drawIoU();

        // Precision/Recall Visualization
        const prCanvas = document.getElementById('prCanvas');
        const prCtx = prCanvas.getContext('2d');
        const thresholdSlider = document.getElementById('thresholdSlider');

        // Simulated detections: {x, y, confidence, isTP}
        const detections = [
            {x: 50, y: 80, conf: 0.95, isTP: true, label: 'üêï'},
            {x: 150, y: 60, conf: 0.88, isTP: true, label: 'üêï'},
            {x: 250, y: 100, conf: 0.75, isTP: false, label: '‚ùå'},
            {x: 350, y: 70, conf: 0.65, isTP: true, label: 'üêï'},
            {x: 420, y: 90, conf: 0.55, isTP: true, label: 'üêï'},
            {x: 100, y: 180, conf: 0.45, isTP: false, label: '‚ùå'},
            {x: 200, y: 200, conf: 0.35, isTP: true, label: 'üêï'},
            {x: 300, y: 170, conf: 0.25, isTP: false, label: '‚ùå'},
        ];

        // Actual objects (ground truth)
        const groundTruth = [
            {x: 50, y: 80, label: 'üêï'},
            {x: 150, y: 60, label: 'üêï'},
            {x: 350, y: 70, label: 'üêï'},
            {x: 420, y: 90, label: 'üêï'},
            {x: 200, y: 200, label: 'üêï'},
            {x: 380, y: 190, label: 'üêï'}, // Missed - no detection
        ];

        function drawPR() {
            const threshold = parseInt(thresholdSlider.value) / 100;
            document.getElementById('thresholdValue').textContent = threshold.toFixed(2);
            
            prCtx.clearRect(0, 0, prCanvas.width, prCanvas.height);
            
            // Draw background image area
            prCtx.fillStyle = '#e9ecef';
            prCtx.fillRect(10, 30, 480, 230);
            prCtx.strokeStyle = '#dee2e6';
            prCtx.strokeRect(10, 30, 480, 230);
            
            prCtx.font = '12px sans-serif';
            prCtx.fillStyle = '#666';
            prCtx.fillText('Image with 6 dogs (ground truth)', 10, 20);
            
            let TP = 0, FP = 0, belowThreshold = 0;
            
            // Draw detections
            detections.forEach(det => {
                const isAboveThreshold = det.conf >= threshold;
                
                prCtx.beginPath();
                prCtx.rect(det.x, det.y, 60, 60);
                
                if (!isAboveThreshold) {
                    prCtx.strokeStyle = 'rgba(108, 117, 125, 0.5)';
                    prCtx.fillStyle = 'rgba(108, 117, 125, 0.1)';
                    belowThreshold++;
                } else if (det.isTP) {
                    prCtx.strokeStyle = '#28a745';
                    prCtx.fillStyle = 'rgba(40, 167, 69, 0.2)';
                    TP++;
                } else {
                    prCtx.strokeStyle = '#dc3545';
                    prCtx.fillStyle = 'rgba(220, 53, 69, 0.2)';
                    FP++;
                }
                
                prCtx.lineWidth = 3;
                prCtx.fill();
                prCtx.stroke();
                
                // Confidence label
                prCtx.font = '11px sans-serif';
                prCtx.fillStyle = isAboveThreshold ? '#333' : '#999';
                prCtx.fillText(`${(det.conf * 100).toFixed(0)}%`, det.x + 20, det.y + 75);
            });
            
            // Draw missed ground truth (FN)
            const missedGT = {x: 380, y: 190};
            prCtx.beginPath();
            prCtx.rect(missedGT.x, missedGT.y, 60, 60);
            prCtx.strokeStyle = '#ffc107';
            prCtx.fillStyle = 'rgba(255, 193, 7, 0.2)';
            prCtx.lineWidth = 3;
            prCtx.setLineDash([5, 5]);
            prCtx.fill();
            prCtx.stroke();
            prCtx.setLineDash([]);
            
            // Calculate metrics
            // Total actual dogs = 6, but only 5 have detections above threshold
            const totalGroundTruth = 6;
            const FN = totalGroundTruth - TP;
            
            const precision = TP + FP > 0 ? TP / (TP + FP) : 0;
            const recall = TP / totalGroundTruth;
            
            document.getElementById('precisionValue').textContent = precision.toFixed(2);
            document.getElementById('recallValue').textContent = recall.toFixed(2);
            
            // Stats
            prCtx.font = '12px sans-serif';
            prCtx.fillStyle = '#333';
            prCtx.fillText(`TP: ${TP} | FP: ${FP} | FN: ${FN} | Below threshold: ${belowThreshold}`, 10, 290);
        }

        thresholdSlider.addEventListener('input', drawPR);
        drawPR();

        // AP@50 vs AP@75 visualization
        const apCanvas = document.getElementById('apCanvas');
        const apCtx = apCanvas.getContext('2d');

        function drawAPComparison() {
            apCtx.clearRect(0, 0, apCanvas.width, apCanvas.height);
            
            const boxes = [
                {gtX: 30, predX: 35, iou: 0.82, label: 'Cat #1'},
                {gtX: 140, predX: 160, iou: 0.63, label: 'Cat #2'},
                {gtX: 250, predX: 275, iou: 0.51, label: 'Cat #3'},
                {gtX: 360, predX: 400, iou: 0.45, label: 'Cat #4'},
            ];
            
            boxes.forEach((box, i) => {
                const y = 50;
                const size = 80;
                
                // Ground truth
                apCtx.strokeStyle = '#28a745';
                apCtx.lineWidth = 2;
                apCtx.strokeRect(box.gtX, y, size, size);
                
                // Prediction
                apCtx.strokeStyle = '#007bff';
                apCtx.strokeRect(box.predX, y, size, size);
                
                // IoU value
                const color = box.iou >= 0.75 ? '#28a745' : (box.iou >= 0.5 ? '#ffc107' : '#dc3545');
                apCtx.fillStyle = color;
                apCtx.font = 'bold 14px sans-serif';
                apCtx.fillText(`IoU: ${box.iou}`, box.gtX + 10, y + size + 20);
                
                // Cat emoji
                apCtx.font = '30px sans-serif';
                apCtx.fillText('üê±', box.gtX + 25, y + 55);
            });
            
            // Legend
            apCtx.font = '11px sans-serif';
            apCtx.fillStyle = '#28a745';
            apCtx.fillText('‚ñ† ‚â•0.75 (AP50 ‚úì, AP75 ‚úì)', 30, 180);
            apCtx.fillStyle = '#ffc107';
            apCtx.fillText('‚ñ† 0.50-0.74 (AP50 ‚úì, AP75 ‚úó)', 180, 180);
            apCtx.fillStyle = '#dc3545';
            apCtx.fillText('‚ñ† <0.50 (AP50 ‚úó, AP75 ‚úó)', 350, 180);
        }

        drawAPComparison();

        // PR Curve
        const prCurveCanvas = document.getElementById('prCurveCanvas');
        const prCurveCtx = prCurveCanvas.getContext('2d');

        function drawPRCurve() {
            prCurveCtx.clearRect(0, 0, prCurveCanvas.width, prCurveCanvas.height);
            
            const padding = 50;
            const width = prCurveCanvas.width - padding * 2;
            const height = prCurveCanvas.height - padding * 2;
            
            // Axes
            prCurveCtx.strokeStyle = '#333';
            prCurveCtx.lineWidth = 2;
            prCurveCtx.beginPath();
            prCurveCtx.moveTo(padding, padding);
            prCurveCtx.lineTo(padding, padding + height);
            prCurveCtx.lineTo(padding + width, padding + height);
            prCurveCtx.stroke();
            
            // Labels
            prCurveCtx.font = '14px sans-serif';
            prCurveCtx.fillStyle = '#333';
            prCurveCtx.fillText('Recall', padding + width/2 - 20, padding + height + 35);
            
            prCurveCtx.save();
            prCurveCtx.translate(15, padding + height/2);
            prCurveCtx.rotate(-Math.PI/2);
            prCurveCtx.fillText('Precision', -30, 0);
            prCurveCtx.restore();
            
            // Axis values
            prCurveCtx.font = '11px sans-serif';
            prCurveCtx.fillText('0', padding - 15, padding + height + 5);
            prCurveCtx.fillText('1.0', padding + width - 10, padding + height + 15);
            prCurveCtx.fillText('1.0', padding - 25, padding + 5);
            
            // PR curve data points (simulated realistic curve)
            const prPoints = [
                {r: 0, p: 1.0},
                {r: 0.1, p: 0.98},
                {r: 0.2, p: 0.95},
                {r: 0.3, p: 0.92},
                {r: 0.4, p: 0.88},
                {r: 0.5, p: 0.82},
                {r: 0.6, p: 0.75},
                {r: 0.7, p: 0.65},
                {r: 0.8, p: 0.52},
                {r: 0.9, p: 0.35},
                {r: 1.0, p: 0.15},
            ];
            
            // Fill area under curve
            prCurveCtx.beginPath();
            prCurveCtx.moveTo(padding, padding + height);
            prPoints.forEach(pt => {
                const x = padding + pt.r * width;
                const y = padding + height - pt.p * height;
                prCurveCtx.lineTo(x, y);
            });
            prCurveCtx.lineTo(padding + width, padding + height);
            prCurveCtx.closePath();
            prCurveCtx.fillStyle = 'rgba(102, 126, 234, 0.3)';
            prCurveCtx.fill();
            
            // Draw curve
            prCurveCtx.beginPath();
            prCurveCtx.strokeStyle = '#667eea';
            prCurveCtx.lineWidth = 3;
            prPoints.forEach((pt, i) => {
                const x = padding + pt.r * width;
                const y = padding + height - pt.p * height;
                if (i === 0) prCurveCtx.moveTo(x, y);
                else prCurveCtx.lineTo(x, y);
            });
            prCurveCtx.stroke();
            
            // Draw points
            prPoints.forEach(pt => {
                const x = padding + pt.r * width;
                const y = padding + height - pt.p * height;
                prCurveCtx.beginPath();
                prCurveCtx.arc(x, y, 4, 0, Math.PI * 2);
                prCurveCtx.fillStyle = '#667eea';
                prCurveCtx.fill();
            });
        }

        drawPRCurve();
    </script>
</body>
</html>
